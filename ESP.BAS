>L.

   10REM ESP#33 26/06/22
   20:
   30@%=5
   40HELP$="F1=CLOSE F2=ABORT F3=R.OFF F4=R.ON"
   50MODE7:PROCtwinit(10)
   60OW%=&FFF1:OB%=&FFF4
   70INPUT"Server? "server%
   80IFserver%>0PRINT"CLIENT"ELSEPRINT"SERVER"
   90PROCtw(2):*FX225 240
  100:
  110MTU%=256:PROCeinit
  120PROCtcbinit
  130PROCbbinit(50)
  140:
  150:
  160CN%=FNcsock
  170IFserver%PROCopen(CN%,100,server%,80,FALSE)ELSEPROCopen(CN%,80,0,0,TRUE)
  180:
  190RE%=TRUE:outx%=0:DIM out% 50,in% 50
  200REPEAT
  210PROCepoll:PROCtimer
  220G%=INKEY(0):G$=CHR$G%
  230IFG%=241PROCclose(CN%)
  240IFG%=242PROCabort(CN%)
  250IFG%=243THENRE%=FALSE:PRINT"DISABLE RECV"
  260IFG%=244THENRE%=TRUE:PRINT"ENABLE RECV"
  270IFG%>0ANDG%<128PROCtestvdu
  280IFG%=13ORoutx%>10PROCtestsend
  290R%=0:IFRE%THENR%=FNrecv(CN%,in%,20):IFR%>0PROCtestrecv
  300UNTILR%<0ANDFNstatus(CN%)<1
  310IFFNstatus(CN%)=-1PRINT"CN RESET"
  320IFserver%=0GOTO170
  330PROCdsock(CN%):PROCerst
  340END
  350:
  360DEFPROCout:IFG%<32ORG%>126THENPRINT;"<";G%;">";ELSEVDUG%
  370IFG%=13THENPRINT
  380ENDPROC
  390DEFPROCtestvdu:out%?outx%=G%:outx%=outx%+1:PROCtw(1):PROCout:PROCtw(2):ENDPROC
  400DEFPROCtestsend:LOCALR%:R%=FNsend(CN%,out%,outx%)
  410IFR%<outx%PRINT"SEND ERROR"
  420outx%=0:PRINT"SEND RESULT=";R%:ENDPROC
  430DEFPROCtestrecv:PROCtw(1):FORX%=0TOR%-1:G%=X%?in%:PROCout:NEXT:PROCtw(2):ENDPROC
  440:
  450:
  460DEFPROCow(A%,X%):LOCALY%:Y%=X%DIV256:CALLOW%:ENDPROC
  470DEFFNw(A%)=(!A%)AND&FFFF
  480DEFPROCw(A%,V%):?A%=V%:A%?1=V%DIV256:ENDPROC
  490DEFFNbit(V%,X%)=(V%AND2^X%)>0
  500DEFFNc(A%,B%)=CHR$(129+B%)+CHR$(157)+CHR$(129+A%)
  510DEFPROCtwinit(H%):TW%=0:TWH%=H%:TWX%=1:TWY%=1:PRINTTAB(0,H%);FNc(5,2);HELP$:PROCtw(1):ENDPROC
  520DEFPROCtw(W%):IFTW%=W%ENDPROC
  530LOCALX%,Y%,T%,B%:IFW%=1THENT%=0:B%=TWH%-1:ELSET%=TWH%+1:B%=23
  540X%=POS:Y%=VPOS:VDU28,0,B%,39,T%,31,TWX%,TWY%:TWX%=X%:TWY%=Y%:TW%=W%:ENDPROC
  550DEFPROCdump(A%,L%):LOCALX%:FORX%=0TOL%-1:PRINT;X%?L%;" ";:NEXT:PRINT:ENDPROC
  560:
  570:
  580REM BUFFER ROUTINES
  590DEFPROCbbinit(Z%):BBX%=TBX%*2:BBY%=4:DIM BB%(BBX%,BBY%)
  600FORX%=1TOBBX%:DIM B% Z%:BB%(X%,2)=Z%:BB%(X%,3)=B%:PRINT"BB ";X%,~BB%(X%,2),~BB%(X%,3):NEXT:ENDPROC
  610DEFFNbballoc:LOCALX%,B%:FORX%=0TOBBX%:IFNOTBB%(X%,1)B%=X%
  620NEXT:IFB%>0BB%(B%,1)=TRUE:BB%(B%,4)=0
  630=B%
  640DEFPROCbbfree(B%):IFB%=0ENDPROC
  650BB%(B%,1)=FALSE:ENDPROC
  660DEFFNbbcopy(B%,V%,A%,P%,M%):LOCALZ%,G%,O%,L%,X%,Y%:Z%=BB%(B%,2):G%=BB%(B%,3):O%=BB%(B%,4):IFP%>=Z%THEN=0
  670Y%=(O%+P%)MODZ%:L%=Z%-P%:IFL%>M%THENL%=M%
  680FORX%=0TOL%-1:IFV%THENG%?Y%=A%?X%ELSEA%?X%=G%?Y%
  690Y%=(Y%+1)MODZ%:NEXT:=L%
  700DEFPROCbbadorig(B%,X%):BB%(B%,4)=(BB%(B%,4)+X%)MODBB%(B%,2):ENDPROC
  710:
  720REM POPULATE TCB VARIABLES
  730DEFPROCtcbinit:TBX%=4:TBY%=22:ATB%=0:DIM TB%(TBX%,TBY%):FORX%=1TOTBX%:TB%(X%,1)=-2:NEXT:ENDPROC
  740DATATB%(T%,1),TB%(T%,2),TB%(T%,3),TB%(T%,4),TB%(T%,6),TB%(T%,7),TB%(T%,8),TB%(T%,10),TB%(T%,11),TB%(T%,12),TB%(T%,13),TB%(T%,14),TB%(T%,15),TB%(T%,16),TB%(T%,17),TB%(T%,18),TB%(T%,19),TB%(T%,9),TB%(T%,20),TB%(T%,21),TB%(T%,22)
  750DATASTT%,LPORT%,DPORT%,DSTN%,RXB%,TXB%,ISS%,SH%,SU%,SN%,SW%,SWL1%,SWL2%,RN%,RW%,RT%,IRS%,FIN%,RTO%,TM%,RFIN%
  760DEFPROCldtcb(T%):STT%=0:IFT%=0ENDPROC
  770RESTORE740:READSTT%,LPORT%,DPORT%,DSTN%,RXB%,TXB%,ISS%,SH%,SU%,SN%,SW%,SWL1%,SWL2%,RN%,RW%,RT%,IRS%,FIN%,RTO%,TM%,RFIN%
  780ATB%=T%:ENDPROC
  790DEFPROCsvtcb:IFATB%=0ENDPROC
  800LOCALT%:T%=ATB%:RESTORE750
  810READTB%(T%,1),TB%(T%,2),TB%(T%,3),TB%(T%,4),TB%(T%,6),TB%(T%,7),TB%(T%,8),TB%(T%,10),TB%(T%,11),TB%(T%,12),TB%(T%,13),TB%(T%,14),TB%(T%,15),TB%(T%,16),TB%(T%,17),TB%(T%,18),TB%(T%,19),TB%(T%,9),TB%(T%,20),TB%(T%,21),TB%(T%,22)
  820STT%=0:ATB%=0:ENDPROC
  830:
  840:
  850REM Econet stuff
  860DEFPROCeinit:RXCB%=0:DIMTXBUF% MTU%,RXBUF% MTU%,CB% 20:PROCerst:ENDPROC
  870:
  880DEFPROCerst:FORX%=3TO17:PROCrxdel2(X%):NEXT:ENDPROC
  890:
  900DEFFNlisten(S%,P%,B%,L%)
  910REMPRINT"LISTEN: S=";S%;" P=";P%;" B=";~B%;" L=";L%
  920LOCALR%
  930?CB%=0:CB%?1=&7F:CB%?2=P%
  940CB%!3=S%:CB%!5=B%:CB%!9=B%+L%
  950PROCow(&11,CB%)
  960R%=?CB%:IFR%=0:PRINT"RX#1"
  970REMPRINT"RX BLK=";R%
  980=R%
  990:
 1000DEFFNtransmit(D%,P%,C%,B%,L%)
 1010REMPRINT"TXMIT: D=";D%;" P=";P%;" C=";~C%;" B=";~B%;" L=";L%
 1020LOCALA%,X%
 1030?CB%=C%:CB%?1=P%:CB%!2=D%
 1040CB%!4=B%:CB%!8=B%+L%
 1050PROCow(&10,CB%)
 1060IF?CB%=0:PRINT"TX#1":GOTO1030
 1070:
 1080A%=&32:!&70=USR(OB%):X%=?&71
 1090IFX%>=&80:GOTO1080
 1100IFX%<>0:PRINT"TX#2 ";~X%
 1110=X%
 1120:
 1130DEFFNrxpoll(B%)
 1140LOCALA%,X%:IFB%=0:=0
 1150A%=&33:X%=B%:!&70=USR(OB%):=?&71
 1160:
 1170DEFPROCrxread(B%)
 1180LOCALL%,R%,N%,P%,C%
 1190?CB%=B%:PROCow(&11,CB%)
 1200RXS%=FNw(CB%+3):RXP%=CB%?2
 1210RXC%=CB%?1:RXA%=CB%!5:RXL%=CB%!9-RXA%
 1220REMPRINT"RX(";B%;") STN=";RXS%;" LEN=";RXL%;" PORT=";RXP%;" CTRL=";~RXC%;" BUF=";~RXA%
 1230ENDPROC
 1240:
 1250DEFPROCrxdel(X%)
 1260REMPRINT"DEL RX BLK ";X%
 1270DEFPROCrxdel2(X%)
 1280LOCALA%:A%=&34:CALLOB%:ENDPROC
 1290:
 1300DEFPROCepoll
 1310IFFNrxpoll(RXCB%)>127PROCrxread(RXCB%):RXCB%=0:IFRXL%>=6PROCgotseg
 1320IFRXCB%=0THENRXCB%=FNlisten(0,0,RXBUF%,MTU%)
 1330ENDPROC
 1340:
 1350:
 1360DATA CLOSED,LISTEN,SYN-SENT,SYN-RCVD,ESTAB,FIN-WAIT1,FIN-WAIT2,CLOSE-WAIT,CLOSING,LAST-ACK,TIME-WAIT
 1370DEFFNstate(V%):RESTORE1360:LOCALX%,V$:FORX%=0TOV%:READV$:NEXT:=V$
 1380DEFPROCsetstate(V%)
 1390PRINTFNc(2,0);"TCB ";ATB%;" TO ";FNstate(V%):STT%=V%:ENDPROC
 1400:
 1410DATA ACK,RST,SYN,FIN
 1420DEFFNflags(F%):RESTORE1410:LOCALX%,D$,R$:FORX%=6TO3STEP-1:READD$:IFFNbit(F%,X%)THENR$=R$+","+D$
 1430NEXT:=MID$(R$,2)
 1440:
 1450:
 1460DEFFNfindsock(P%,S%)
 1470LOCALT%,X%:FORX%=1TOTBX%:IFTB%(X%,1)>0ANDTB%(X%,2)=P%ANDTB%(X%,4)=S%THENT%=X%
 1480NEXT:=T%
 1490:
 1500DEFPROCgotseg
 1510LOCALT%:T%=FNfindsock(RXP%,RXS%)
 1520IFT%=0THENT%=FNfindsock(RXP%,0)
 1530PROCldtcb(T%)
 1540:
 1550LOCALP%,W%,Q%,A%,L%,LT%,FA%,FR%,FS%,FF%
 1560FA%=FNbit(RXC%,6):FR%=FNbit(RXC%,5):FS%=FNbit(RXC%,4):FF%=FNbit(RXC%,3):P%=?RXA%:W%=(RXC%AND7)*256+RXA%?1:Q%=FNw(RXA%+2):A%=FNw(RXA%+4):L%=RXL%-6-FS%-FF%
 1570:
 1580PRINTFNc(6,3);"RXSEG: SST=";RXS%;" SPORT=";P%;" LPORT=";RXP%
 1590PRINT"TCB ",T%
 1600PRINT"FLAGS=";FNflags(RXC%);" SEQ=";Q%;" ACK=";A%;" WND=";W%;" LEN=";L%
 1610PRINT"WIN=";W%;" SEQ=";Q%;" ACK=";A%
 1620PRINT
 1630:
 1640IFSTT%=0GOTO1670
 1650PROCprocseg:PROCsvtcb:ENDPROC
 1660REM closed
 1670IFNOTFR%PROCsendrst(FA%)
 1680ENDPROC
 1690:
 1700DEFPROCprocseg
 1710IFSTT%>1GOTO1820
 1720REM LISTEN
 1730IFFR%ENDPROC
 1740IFFA%PROCsendrst(TRUE):ENDPROC
 1750IFNOTFS%ENDPROC
 1760PROCinit:DPORT%=P%:DSTN%=RXS%
 1770RN%=Q%+1:RT%=RN%:IRS%=Q%
 1780PRINT"IRS = ";Q%
 1790PROCsetstate(3):PROCsendseg
 1800ENDPROC
 1810:
 1820IFSTT%>2GOTO1950
 1830REM SYN-SENT
 1840IFNOTFA%GOTO1870
 1850IFA%<ISS%ORA%>SN%PRINT"SYN-SENT FIRST CHECK":PROCsendrst(TRUE):ENDPROC
 1860IFFR%THENSTT%=-1:ENDPROC
 1870IFFR%ORNOTFS%ENDPROC
 1880RN%=Q%+1:RT%=RN%:IRS%=Q%
 1890IFFA%THENSU%=A%:TM%=0:PROCupswnd
 1900IFSU%>ISS%THENPROCsetstate(4):GOTO1950:ELSEPROCsetstate(3)
 1910PROCsendseg
 1920ENDPROC
 1930:
 1940REM OTHERWISE
 1950PRINT"OTHERWISE?"
 1960PRINT"SEG  ";Q%;" ";Q%+L%-1
 1970REM 1ST CHECK SEQUENCE NUMBER
 1980IFFNtestwin GOTO2020
 1990PRINT"OUT OF WINDOW"
 2000IFNOTFR%PROCsendseg
 2010ENDPROC
 2020PRINT"IN WINDOW":PROCtrimseg
 2030PRINT"TRIM ";Q%;" ";Q%+L%-1;" LT=";LT%;" L=";L%
 2040:
 2050REM 2ND CHECK RST BIT
 2060IFNOTFR%GOTO2110
 2070STT%=-1:PRINT"SEG RESET?!"
 2080ENDPROC
 2090:
 2100REM 4TH CHECK SYN BIT
 2110IFNOTFS%GOTO2160
 2120PRINT"SYN IN WINDOW, SEND RESET!"
 2130ENDPROC
 2140:
 2150REM 5TH CHECK ACK FIELD
 2160IFNOTFA%ENDPROC
 2170IFSTT%<>3GOTO2220
 2180REM (5TH CHECK) SYN-RCVD
 2190IFNOT(SU%<=A%ANDA%<=SN%)PROCsendrst(TRUE):ENDPROC
 2200PROCsetstate(4)
 2210:
 2220IFSTT%>8GOTO2370
 2230REM (5TH CHECK) ESTAB,...,CLOSING
 2240IFA%>SN%PRINT"INVALID ACK":PROCsendseg:ENDPROC
 2250IFA%<=SU%PRINT"DUPLICATE ACK":GOTO2420
 2260LOCALAL%:AL%=A%-SU%+FS%:REM NO.OF BYTES IN BUFFER ACKED
 2270PRINT"VALID ACK: AL=";AL%
 2280TM%=0:PRINT"CLEAR TIMEOUT"
 2290PROCbbadorig(TXB%,AL%):SU%=A%:PROCupswnd
 2300REM in addition...
 2310IFSTT%=5ANDA%=SN%PROCsetstate(6)
 2320IFSTT%=6ANDSN%=SH%PRINT"CLOSE ACK"
 2330IFSTT%=8ANDA%=SN%PROCsetstate(10)
 2340GOTO2420
 2350:
 2360REM (5TH CHECK) LAST ACK/TIME-WAIT
 2370IFSTT%=9ANDA%=SN%PROCsetstate(0)
 2380IFSTT%=10PROCsendseg:PRINT"RESTART TIMER"
 2390ENDPROC
 2400:
 2410REM 7TH, PROCESS SEG DATA
 2420IFSTT%<7PROCdata
 2430:
 2440REM 8TH CHECK FIN BIT
 2450IFNOTFF%GOTO2530
 2460LOCAL NSTT%:NSTT%=STT%
 2470IFSTT%<5THEN NSTT%=7
 2480IFSTT%=5THEN NSTT%=8
 2490IFSTT%=6THEN NSTT%=10
 2500IFNSTT%<>STT%PROCsetstate(NSTT%)
 2510RN%=RN%+1:RFIN%=TRUE:REM ACK FIN
 2520:
 2530IFL%>0ORSH%>SN%PROCsendseg:REM SEND ACK (AND DATA?)
 2540PRINT"END OF SEG PROC"
 2550ENDPROC
 2560:
 2570:
 2580REM DELIVER DATA
 2590DEFPROCdata:LOCALPLEN%:PLEN%=L%+FS%+FF%
 2600IFPLEN%=0ENDPROC
 2610PRINT"DATA LTRIM = ";LT%;" PLEN=";PLEN%
 2620LOCALR%:R%=FNbbcopy(RXB%,TRUE,RXBUF%+6+LT%,RN%-RT%,L%)
 2630PRINTR%;" BYTES COPIED TO BUFFER!"
 2640RN%=RN%+R%:RW%=BB%(RXB%,2)-(RN%-RT%)
 2650ENDPROC
 2660:
 2670REM UPDATE SEND WINDOW?
 2680DEFPROCupswnd:IF(SWL1%<Q% OR (SWL1%=Q% AND SWL2%<=A%))THENSW%=W%:SWL1%=Q%:SWL2%=A%:PRINT"UPDATE SND.WND=";SW%
 2690ENDPROC
 2700:
 2710REM IS SEG IN WINDOW?
 2720DEFFNtestwin
 2730IFL%=0ANDRW%=0THEN=Q%=RN%
 2740IFL%>0ANDRW%=0THEN=FALSE
 2750LOCALRE%,QE%:RE%=RN%+RW%:QE%=Q%+L%-1
 2760IFRN%<=Q%ANDQ%<RE%THEN=TRUE
 2770IFL%=0THEN=FALSE
 2780=(RN%<=QE%ANDQE%<RE%)
 2790:
 2800REM TRIM SEG
 2810DEFPROCtrimseg:LOCALX%,Y%
 2820REM LEFT TRIM?
 2830IFQ%>=RN%GOTO2880
 2840PRINT"LEFT TRIM":IFFS%THENFS%=FALSE:Q%=Q%+1:L%=L%-1:PRINT"TRIM SYN":GOTO2830
 2850PRINT"TRIM PAYLOAD":LT%=RN%-Q%:L%=L%-LT%:Q%=RN%
 2860:
 2870REM RIGHT TRIM?
 2880X%=Q%+L%-1:Y%=RN%+RW%:IFX%<Y%ENDPROC
 2890PRINT"RIGHT TRIM":IFNOTFF%THENL%=Y%-Q%:ENDPROC
 2900IFX%=Y%PRINT"NO NEED TO TRIM FIN":ENDPROC
 2910PRINT"TRIM FIN":FF%=FALSE:L%=L%-1:GOTO2880
 2920:
 2930:
 2940:
 2950REM RESET1 = SEQ=0,ACK=SEG.SEQ+SEG.LEN,CTL=RST+ACK
 2960REM RESET2 = SEQ=SEG.ACK,CTL=RST
 2970DEFPROCsendrst(Y%)
 2980LOCALRQ%,RA%,RFA%
 2990IFNOTY%PRINT"RESET1":RA%=Q%+L%:RFA%=TRUE:ELSEPRINT"RESET2":RQ%=A%
 3000PROCtxseg(RXS%,P%,RXP%,RQ%,RA%,0,0,RFA%,TRUE,FALSE,FALSE):ENDPROC
 3010:
 3020REM RESET = SEQ=SND.NXT,CTL=RST
 3030DEFPROCsendrst2:PROCtxseg(DSTN%,DPORT%,LPORT%,SN%,0,0,0,FALSE,TRUE,FALSE,FALSE):ENDPROC
 3040:
 3050DEFPROCsendseg:LOCALW%,PLEN%,FA%,FS%,FF%:FS%=STT%<4:FA%=STT%>2
 3060PRINTFNc(6,5);"sendseg"
 3070:
 3080REM PAYLOAD? W%=remaining window
 3090IFSN%<SH%THENPLEN%=SH%-SN%
 3100IFPLEN%>(MTU%-6)THENPLEN%=MTU%-6
 3110W%=SW%-(SN%-SU%)
 3120REM ZERO WINDOW PROBE?
 3130IFPLEN%>0ANDW%=0ANDNOTFS%THENW%=1
 3140IFW%<PLEN%THENPLEN%=W%
 3150PLEN%=FNbbcopy(TXB%,FALSE,TXBUF%+6,SN%-SU%,PLEN%)
 3160PRINT"PAYLOAD LEN=";PLEN%;" (REM.WND=";W%;")"
 3170:
 3180IF(STT%=5ORSTT%=8ORSTT%=9)ANDSN%+PLEN%=SH%THENFF%=TRUE
 3190PROCtxseg(DSTN%,DPORT%,LPORT%,SN%,RN%,RW%,PLEN%,FA%,FALSE,FS%,FF%)
 3200SN%=SN%+PLEN%-FS%-FF%
 3210REM SET TIMER IF SEG.LEN>0
 3220IF(PLEN%-FS%-FF%)>0THENTM%=TIME+RTO%*100
 3230PRINT"SU=";SU%;" SN=";SN%;" SH=";SH%
 3240ENDPROC
 3250:
 3260DEFPROCtxseg(D%,P%,LP%,Q%,A%,W%,PLEN%,FA%,FR%,FS%,FF%)
 3270LOCALF%:IFFA%THENF%=&40
 3280IFFR%THENF%=F%OR&20
 3290IFFS%THENF%=F%OR&10
 3300IFFF%THENF%=F%OR8
 3310?TXBUF%=LP%:TXBUF%?1=W%:PROCw(TXBUF%+2,Q%):PROCw(TXBUF%+4,A%):F%=F%OR((W%DIV256)AND7)
 3320PRINTFNc(3,2);"TXSEG: DST=";D%;" DPORT=";P%;" LPORT=";LP%
 3330PRINT"FLAGS=";FNflags(F%);" SEQ=";Q%;" ACK=";A%;" WND=";W%;" PLEN=";PLEN%
 3340LOCALR%:R%=FNtransmit(D%,P%,&80ORF%,TXBUF%,PLEN%+6):ENDPROC
 3350:
 3360:
 3370REM create socket
 3380DEFFNcsock:LOCALB1%,B2%:B1%=FNbballoc:B2%=FNbballoc:IFB1%=0ORB2%=0:PROCbbfree(B1%):PROCbbfree(B2%):PRINT"NO FREE BUFFERS":=0
 3390LOCALT%,X%:FORX%=1TOTBX%:IFTB%(X%,1)=-2:T%=X%
 3400NEXT:IFT%=0:PRINT"NO FREE TCBS":=0
 3410PRINT"NEW TCB = ";T%
 3420PRINT"BUFFERS = ";B1%,B2%
 3430TB%(T%,6)=B1%:TB%(T%,7)=B2%:=T%
 3440:
 3450REM delete socket
 3460DEFPROCdsock(T%):IFT%=0:ENDPROC
 3470IFTB%(T%,1)=-2:ENDPROC
 3480PROCbbfree(TB%(T%,6)):PROCbbfree(TB%(T%,7))
 3490TB%(T%,1)=-2:PRINT"dsock ",T%:ENDPROC
 3500:
 3510DEFPROCclose(T%):IFT%=0ENDPROC
 3520IFFIN%ENDPROC
 3530PRINT"CLOSE TCB ";T%
 3540LOCALNSTT%:PROCldtcb(T%)
 3550IFSTT%<3PROCdsock(T%):ENDPROC
 3560IFSTT%<5THENNSTT%=5
 3570IFSTT%=7THENNSTT%=9
 3580IFNSTT%=0ENDPROC
 3590PROCsetstate(NSTT%)
 3600FIN%=TRUE:PROCsendseg:PROCsvtcb
 3610ENDPROC
 3620:
 3630REM STATUS
 3640DEFFNstatus(T%):IFT%=0THEN=0
 3650=TB%(T%,1)
 3660:
 3670REM open socket
 3680DEFPROCopen(T%,P%,D%,DP%,LSTN%)
 3690PRINT"OPEN sock=";T%;" loc.port=";P%;" dest.stn=";D%;" dest.port=";DP%;" listen=";LSTN%
 3700LOCALX%:FORX%=8TOTBY%:TB%(T%,X%)=0:NEXT
 3710PROCldtcb(T%):LPORT%=P%:DPORT%=DP%:DSTN%=D%:IFNOTLSTN%GOTO3770
 3720:
 3730REM listen
 3740PROCsetstate(1):PROCsvtcb:ENDPROC
 3750:
 3760REM connect
 3770PRINT"connect ",T%
 3780PROCinit:PROCsetstate(2):PROCsendseg:PROCsvtcb:ENDPROC
 3790:
 3800REM init TCB, recv.wnd=buf.size
 3810DEFPROCinit:ISS%=(TIME MOD 1000)*10:SU%=ISS%:SN%=ISS%:SH%=ISS%+1:RW%=BB%(RXB%,2):RTO%=1
 3820PROCtw(1):PRINTFNc(2,5);"INIT ";T%;" ISS=";ISS%;" RW=";RW%:PROCtw(2):ENDPROC
 3830:
 3840DEFFNsend(T%,A%,L%):IFT%=0THEN=-1
 3850IFTB%(T%,1)<1THEN=-1
 3860PROCldtcb(T%):IFFIN%THEN=-1
 3870IFDSTN%=0ORDPORT%=0THEN=-1
 3880LOCALR%,H%:H%=SH%-SU%:R%=FNbbcopy(TXB%,TRUE,A%,H%,L%):SH%=SH%+R%
 3890PRINT"SH=";SH%
 3900PROCsendseg:PROCsvtcb:=R%
 3910:
 3920DEFFNrecv(T%,A%,M%):IFT%=0THEN=-1
 3930REM cnn might be closed but there may still be data in the receive buffer
 3940IFTB%(T%,1)<0THEN=-1
 3950LOCALL%,X%,N%,Y%:N%=TB%(T%,16):Y%=TB%(T%,18)
 3960L%=(N%+RFIN%)-Y%:IFL%>M%THENL%=M%
 3970IFL%=0GOTO4060
 3980PRINT"RECV: T=";Y%;" N=";N%;" L=";L%;" RFIN=";RFIN%
 3990PROCldtcb(T%)
 4000X%=FNbbcopy(RXB%,FALSE,A%,0,L%)
 4010PROCbbadorig(RXB%,X%):RT%=RT%+X%
 4020RW%=BB%(RXB%,2)-(RN%-RT%)
 4030PROCsvtcb:=X%
 4040REM IF BUFFER EMPTY AND FIN REC'D
 4050REM RETURN -1
 4060IFRFIN%THEN=-1ELSE=0
 4070:
 4080DEFPROCabort(T%):IFT%=0ENDPROC
 4090PRINT"ABORT ";T%
 4100PROCldtcb(T%)
 4110IFSTT%>2ANDSTT%<8PROCsendrst2
 4120IFSTT%>-2THENTB%(T%,1)=-1
 4130ENDPROC
 4140:
 4150DEFPROCtimer
 4160LOCALT%:FORT%=1TOTBX%
 4170IFTB%(T%,1)=10THENPRINT"2MSL TIMEOUT ";T%:TB%(T%,1)=0
 4180IFTB%(T%,1)>0ANDTB%(T%,21)>0ANDTIME>TB%(T%,21)THENPROCtimeout
 4190NEXT:ENDPROC
 4200:
 4210DEFPROCtimeout
 4220PRINT"TIMEOUT ";T%
 4230PROCldtcb(T%):TM%=0:SN%=SU%:PROCsendseg:PROCsvtcb
 4240ENDPROC
>*SPOOL

